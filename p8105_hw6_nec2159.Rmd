---
title: "p8105_hw6_nec2159"
author: "Nicole Criscuolo"
date: "2025-11-18"
output: github_document
---
## CHANGE # BOOTSTRAPS PROBLEM 2

```{r setup, include=FALSE}
library(p8105.datasets)
library(tidyverse)
library(modelr)
library(glmnet)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(1)
```

## Problem 1

```{r}
homicide_df =
  read_csv("data/homicide-data.csv") |> 
  mutate(
    state = toupper(state),
    city_state = paste(city, state, sep = ", "),
    solved = factor(if_else(disposition %in% c("Closed without arrest", "Open/No arrest"), "No", "Yes")),
    victim_age = as.numeric(victim_age)) |> 
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
         victim_race %in% c("White", "Black"))

baltimore_df =
  homicide_df |> 
  filter(city_state == "Baltimore, MD")
```

```{r}
baltimore_model =
  glm(solved ~ victim_age + victim_sex + victim_race, data = baltimore_df, family = binomial)

baltimore_model |> 
  broom::tidy(conf.int = TRUE, exponentiate = TRUE) |> 
  filter(term == "victim_sexMale") |> 
  select(estimate, conf.low, conf.high)
```

In homicide cases in Baltimore, MD, male victims had 0.4255117 times the odds of having their cases solved compared to female victims after adjusting for age and race. We are 95% confident that the true odds ratio for male versus female victims is between 0.3241908 and 0.5575508.

```{r}
all_city_results =
homicide_df |> 
  nest(data = -city_state) |> 
  mutate(
    fits = map(data, \(df) glm(solved ~ victim_age + victim_sex + victim_race, data = df, family = binomial)),
    results = map(fits, \(x) broom::tidy(x, conf.int = TRUE, exponentiate = TRUE))
  ) |> 
  unnest(results) |> 
  select(city_state, term, estimate, conf.low, conf.high) |> 
  filter(term == "victim_sexMale")
```

```{r}
all_city_results |> 
  mutate(city_state = reorder(city_state, estimate)) |> 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    x = "City",
    y = "Estimated Odds Ratio",
    title = "Estimated Odds Ratio for Each City"
  )
```

After comparing all the cities, NYC is where male homicide victims had the lowest odds of having their cases solved relative to female victims after adjusting for age and race. Albuquerque is the city where male homicide victims had the highest odds of having their cases solved relative to female victims after adjusting for age and race.

## Problem 2

```{r}
data("weather_df")

estimates =
weather_df |> 
  modelr::bootstrap(n = 500) |> 
  mutate(
    models = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
    tidy_results = map(models, broom::tidy),
    glance_results = map(models, broom::glance),
    beta_ratio = map_dbl(tidy_results, \(x) x[["estimate"]][2] / x[["estimate"]][3]),
    r_squared = map_dbl(glance_results, "r.squared")
    ) |> 
  select(.id, beta_ratio, r_squared)
```

```{r}
estimates |> 
  ggplot(aes(x = beta_ratio)) +
  geom_histogram(fill = "lavender", color = "purple") +
  labs(
    title = "Bootstrap Distribution of Beta Ratio"
  )
```

The distribution of $\frac{\hat{\beta}_1}{\hat{\beta}_2}$ appears to be left-skewed. This means there is a larger cluster of ratios on the higher end, indicating that in many bootstrap samples, ${\hat{\beta}_1}$ tends to be relatively large or ${\hat{\beta}_2}$ tends to be relatively small compared to their typical values. Intuitively, it is probably more likely that ${\hat{\beta}_2}$ is more variable than ${\hat{\beta}_1}$ since minimum and maximum temperature are most likely more correlated than precipitation and maximum temperature.

```{r}
estimates |> 
  ggplot(aes(x = r_squared)) +
  geom_histogram(fill = "lavender", color = "purple") +
  labs(
    title = "Bootstrap Distribution of R Squared"
  )
```

The distribution of $R^2$ appears to be normally distributed and centered around 0.941. Most estimates are very close to this value, indicating the proportion of variance explained by the model is high across bootstrap samples.

```{r}
beta_ratio_CI =
estimates |> 
  pull(beta_ratio) |> 
  quantile(c(.025, .975))
```

```{r}
estimates |> 
  pull(r_squared) |> 
  quantile(c(.025, .975))
```

## Problem 3

```{r}
bwt_df =
  read_csv("data/birthweight.csv") |> 
  janitor::clean_names() |> 
  mutate(babysex = case_match(
    babysex,
    1 ~ "male",
    2 ~ "female"),
    babysex = fct_infreq(babysex),
    frace = 
        case_match(frace,
            1 ~ "white",
            2 ~ "black", 
            3 ~ "asian", 
            4 ~ "puerto rican", 
            8 ~ "other"),
    frace = fct_infreq(frace),
    mrace = 
        case_match(mrace,
            1 ~ "white",
            2 ~ "black", 
            3 ~ "asian", 
            4 ~ "puerto rican",
            8 ~ "other"),
    mrace = fct_infreq(mrace),
    malform = as.logical(malform)) |> 
  sample_n(100)
```

```{r}
x = model.matrix(bwt ~ ., bwt_df) [, -1]
y = bwt_df |> pull(bwt)

lambda = 10^(seq(-2, 2.75, 0.1))

lasso_cv =
  cv.glmnet(x = x, y = y, lambda = lambda)

lambda_opt = lasso_cv[["lambda.min"]]
```

```{r}
lasso_fit =
  glmnet(x = x, y = y, lambda = lambda_opt)

lasso_fit |> 
  broom::tidy()
```

LASSO was used to build a regression model for birth weight as it performs variable selection and coefficient shrinkage. The data was first converted into numerical format with x as the predictors and y as the outcome. A grid of lambda values along with cross validation was then used to determine the optimal lambda which determines the amount of shrinkage applied to each coefficient. This is the lambda that was then used to fit the proposed regression model.

```{r}
lasso_model = lm(bwt ~ bhead + blength + fincome + frace + mrace, data = bwt_df)

bwt_df |> 
  add_predictions(lasso_model) |> 
  add_residuals(lasso_model) |> 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(color = "purple") +
  labs(
    x = "Fitted Values",
    y = "Residuals",
    title = "Residuals vs Fitted Values"
  )
```

```{r}
main_effects_model = lm(bwt ~ blength + gaweeks, data = bwt_df)
main_effects_model

interactions_model = lm(bwt ~ bhead * blength * babysex, data = bwt_df)
interactions_model
```

Cross validation.
```{r}
bwt_df_cv =
  bwt_df |> 
  mutate(id = row_number())

train_df = sample_frac(bwt_df_cv, size = .8)

test_df = anti_join(bwt_df_cv, train_df, by = "id")
```

```{r}
cv_df =
  crossv_mc(bwt_df_cv, n = 100) |> 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )
```

```{r, error = TRUE}
cv_df |> 
  mutate(
    lasso_fit = map(train, \(df) lm(bwt ~ bhead + blength + fincome + frace + mrace, data = df)),
    main_effects_fit = map(train, \(df) lm(bwt ~ blength + gaweeks, data = df)),
    interactions_fit = map(train, \(df) lm(bwt ~ bhead * blength * babysex, data = df))
  )  |> 
  mutate(
    pe_lasso = map2_dbl(lasso_fit, test, rmse),
    pe_main_effects = map2_dbl(main_effects_fit, test, rmse),
    pe_interactions = map2_dbl(interactions_fit, test, rmse)
    )
```  
  


